<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title> <!-- No Default Title -->

<script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) { return false; } 
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; }
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { return false; }
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; }
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; }
        }
    </script>
    
    <!-- Dynamic Favicon -->
    <link id="dynamic-favicon" rel="icon" href="data:,">
    
    <!-- Icons & Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #00C853; 
            --dark-bg: #1e272e;
            --light-bg: #f5f6fa;
            --text-dark: #2d3436;
            --danger: #ff4757;
            --warning: #ffa502;
        }
        /* Applied 'Outfit' font globally */
        * { box-sizing: border-box; outline: none; font-family: 'Outfit', sans-serif; }
        
        body { margin: 0; background: var(--light-bg); color: var(--text-dark); overflow-x: hidden; }
        
        /* --- TOAST NOTIFICATION --- */
        #toast-box {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(30, 39, 46, 0.95); color: white;
            padding: 12px 25px; border-radius: 50px; font-size: 13px; font-weight: 500;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 9999;
            opacity: 0; visibility: hidden; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex; align-items: center; gap: 12px;
        }
        #toast-box.show { opacity: 1; visibility: visible; bottom: 50px; }
        #toast-box i { font-size: 16px; }

        /* Login & Modal Overlays */
        #auth-overlay, #reply-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        
        /* Login Box */
        .login-box { 
            text-align: center; width: 320px; padding: 40px 30px; 
            background: #2d3436; border-radius: 12px; color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            animation: popIn 0.3s ease;
        }
        .login-box h2 { margin-top: 0; color: var(--primary); margin-bottom: 15px; } 
        
        /* Inline Error Message */
        .login-error-text {
            color: #ff4757;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
            background: rgba(255, 71, 87, 0.15);
            padding: 10px;
            border-radius: 6px;
            display: none; 
            border: 1px solid rgba(255, 71, 87, 0.3);
            text-align: center;
        }

        .login-box input { width: 100%; padding: 14px; margin: 8px 0; border-radius: 8px; border: none; background: #3d464d; color: white; font-size: 14px; }
        .login-box button { width: 100%; padding: 12px; background: var(--primary); border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 8px; margin-top: 15px; font-size: 16px; }
        
        /* Reply Box */
        .reply-box { 
            text-align: left; width: 350px; padding: 25px; 
            background: #ffffff;
            border-radius: 12px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); 
            animation: popIn 0.3s ease;
            position: relative;
            color: #333;
        }
        .close-icon-btn { position: absolute; top: 15px; right: 15px; font-size: 20px; color: #b2bec3; cursor: pointer; transition: 0.2s; }
        .close-icon-btn:hover { color: #d63031; }
        .reply-box h3 { margin-top: 0; color: var(--primary); margin-bottom: 15px; font-size: 18px; }
        .reply-context { background: #f1f2f6; border-left: 4px solid var(--primary); padding: 10px; border-radius: 4px; font-size: 12px; color: #636e72; margin-bottom: 15px; }
        .reply-context strong { color: #2d3436; display: block; margin-bottom: 4px; }
        .reply-box textarea { width: 100%; padding: 12px; margin: 0; border-radius: 8px; border: 1px solid #dfe6e9; background: #fff; color: #333; font-size: 14px; resize: none; height: 100px; font-family: 'Outfit', sans-serif; }
        .reply-box textarea:focus { border-color: var(--primary); }
        .reply-btn-modal { width: 100%; padding: 12px; background: var(--primary); border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 8px; margin-top: 15px; font-size: 15px; }
        .reply-btn-modal:hover { opacity: 0.9; }

        @keyframes popIn { from{transform: scale(0.9); opacity: 0;} to{transform: scale(1); opacity: 1;} }

        /* Loading Screen */
        #loading-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #ffffff; 
            z-index: 3000; 
            display: flex; justify-content: center; align-items: center; 
        }
        #admin-loader-img {
            max-width: 80%;
            width: 150px; 
            height: auto;
            object-fit: contain;
            animation: pulseLogo 2s infinite ease-in-out;
            display: none; 
        }
        @keyframes pulseLogo {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Layout */
        .header-bar { 
            background: white; 
            padding: 10px 15px; 
            display: flex; align-items: center; 
            gap: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; 
        }
        .menu-btn { font-size: 24px; cursor: pointer; color: var(--text-dark); background: none; border: none; padding: 0; margin-right: 0; }
        .header-title { 
            font-size: 20px; font-weight: 700; color: var(--primary); 
            margin-left: 0; 
        }
        
        .main-content { padding: 20px; max-width: 800px; margin: 0 auto; min-height: 90vh; }
        .hidden { display: none !important; }

        /* Sidebar */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; display: none; }
        .sidebar { position: fixed; top: 0; left: -260px; width: 260px; height: 100%; background: var(--dark-bg); color: white; transition: 0.3s; z-index: 1000; display: flex; flex-direction: column; box-shadow: 2px 0 15px rgba(0,0,0,0.2); }
        .sidebar.active { left: 0; }
        .brand { padding: 25px; font-size: 22px; font-weight: bold; border-bottom: 1px solid #353b48; text-align: center; }
        .brand span { color: var(--primary); }
        
        /* UPDATED: Removed padding from .menu to eliminate gap */
        .menu { list-style: none; padding: 0; margin: 0; } 
        
        .menu li { padding: 15px 25px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 15px; font-size: 15px; position: relative; }
        .menu li:hover { background: #353b48; color: var(--primary); }
        .menu li.active { background: #353b48; border-left: 4px solid var(--primary); }
        .btn-logout { margin-top: auto; padding: 15px; background: #c0392b; color: white; border: none; cursor: pointer; font-weight: 600; }

        /* Badge Count */
        .badge-count {
            background: #00C853; color: white;
            font-size: 11px; font-weight: bold;
            padding: 3px 8px; border-radius: 12px;
            margin-left: auto;
        }

        /* Stats Cards */
        .stats-row { display: flex; gap: 12px; margin-bottom: 12px; flex-direction: row !important; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .stat-title { font-size: 11px; color: #636e72; font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
        .stat-num { font-size: 20px; font-weight: 700; color: #2d3436; }
        .stat-icon { font-size: 18px; margin-bottom: 4px; color: var(--primary); }
        .c-blue { color: #0984e3; }
        .c-green { color: #00b894; }
        .c-orange { color: #e17055; }

        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .chart-container { position: relative; height: 300px; width: 100%; padding: 10px; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #dcdde1; border-radius: 6px; }
        
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn-success { background: var(--primary); color: white; width: 100%; }
        .btn-cancel { background: #dcdde1; color: #333; margin-top: 10px; width: 100%; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f1f2f6; font-size: 11px; text-transform: uppercase; color: #636e72; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; vertical-align: middle; }
        .t-img { width: 35px; height: 35px; border-radius: 6px; object-fit: cover; }
        
        .spread-table th:first-child, .spread-table td:first-child { text-align: left; width: 50%; } 
        .spread-table th:last-child, .spread-table td:last-child { text-align: right; } 
        .spread-table th, .spread-table td { text-align: center; } 

        .monthly-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s;
        }
        .monthly-item:hover { background: #f1f2f6; }
        .monthly-item.active { background: #e3f2fd; border-left: 3px solid #0984e3; }
        .m-title { font-weight: 700; color: #2d3436; font-size: 14px; }
        .m-stats { font-size: 11px; color: #636e72; display: flex; gap: 10px; margin-top: 3px; }
        .m-stat span { font-weight: 600; color: #000; }

        .action-btn { padding: 6px 10px; border-radius: 4px; border: none; cursor: pointer; margin-right: 5px; transition: 0.2s; }
        .btn-edit { background: #dff9fb; color: #22a6b3; }
        .btn-del { background: #ff7675; color: white; }
        .btn-approve { background: #00b894; color: white; }
        .btn-toggle-on { background: #00C853; color: white; width: 40px; }
        .btn-toggle-off { background: #b2bec3; color: white; width: 40px; }

        /* Banner & Sponsor Preview */
        .banner-preview { width: 100px; height: 35px; object-fit: cover; border-radius: 4px; border:1px solid #ddd; }
        .sponsor-preview { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border:1px solid #ddd; }

        /* CUSTOM COMMUNITY CHAT STYLES */
        #comm-table th:first-child, #comm-table td:first-child { width: 70%; }
        
        .btn-reply-small { 
            background: linear-gradient(135deg, #6c5ce7, #a29bfe); 
            color: white; font-size: 11px; padding: 5px 12px; 
            box-shadow: 0 2px 5px rgba(108, 92, 231, 0.2); 
            border:none; cursor:pointer; border-radius:20px; 
            display: inline-block; margin-top: 6px;
        }
        .btn-reply-small:hover { transform: translateY(-1px); opacity: 0.9; }

        .comm-user-flex { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .comm-avatar { 
            width: 24px; height: 24px; border-radius: 50%; color: white; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 11px; font-weight: bold; flex-shrink: 0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .req-name { font-weight: 700; color: #2d3436; font-size: 12px; display: block; }
        .req-msg { background: #f1f2f6; padding: 10px; border-radius: 8px; margin-bottom: 5px; font-size: 14px; line-height: 1.5; color: #2d3436; }
        .admin-reply-box { background: #e3f2fd; padding: 8px; border-radius: 6px; margin-top: 5px; border-left: 3px solid #0984e3; font-size: 12px; }
        
        .badge-ver { background: #dfe6e9; color: #2d3436; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; }
        .likes-count { color: #e17055; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .badge-pending { background: #ffeaa7; color: #d35400; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }

        @media (max-width: 600px) {
            .stats-row { gap: 8px; }
            .stat-card { padding: 12px; }
        }

        /* Custom Swal - SMALL SIZE & NO ICON */
        .custom-popup-small {
            border-radius: 12px !important;
            padding: 15px !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important;
            font-family: 'Outfit', sans-serif !important;
            width: 280px !important; 
        }
        .custom-popup-title-small {
            font-size: 16px !important;
            font-weight: 700 !important;
            color: #2d3436 !important;
            margin: 0 !important;
        }
        .custom-popup-content-small {
            font-size: 13px !important;
            color: #636e72 !important;
            margin-top: 5px !important;
        }
        /* Buttons for small popup */
        .custom-del-btn { background: #ff4757 !important; color: white !important; border-radius: 6px !important; padding: 8px 15px !important; font-size: 12px !important; font-weight: 600 !important; border: none !important; margin: 0 5px !important; }
        .custom-cancel-btn { background: #f1f2f6 !important; color: #636e72 !important; border-radius: 6px !important; padding: 8px 15px !important; font-size: 12px !important; font-weight: 600 !important; border: none !important; margin: 0 5px !important; }

        .section-header { margin-top: 30px; margin-bottom: 10px; font-size: 16px; font-weight: bold; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .ad-name-badge { font-weight: bold; color: #2d3436; font-size: 14px; }

    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading-screen">
        <img id="admin-loader-img" src="" alt="">
    </div>

    <!-- Toast Notification -->
    <div id="toast-box">
        <i id="toast-icon" class="fas fa-check-circle"></i> 
        <span id="toast-msg">Action Successful</span>
    </div>

    <!-- Login -->
    <div id="auth-overlay" class="hidden">
        <div class="login-box">
            <h2 id="login-title">Admin Access</h2>
            <div id="login-error-text" class="login-error-text">Incorrect Email or Password</div>
            <input type="email" id="email-input" placeholder="Admin Email" oninput="hideLoginError()">
            <input type="password" id="pass-input" placeholder="Password" oninput="hideLoginError()">
            <button onclick="login()">Secure Login</button>
        </div>
    </div>

    <!-- Reply Modal -->
    <div id="reply-overlay" class="hidden">
        <div class="reply-box">
            <div class="close-icon-btn" onclick="closeReply()"><i class="fas fa-times"></i></div>
            <h3><i class="fas fa-reply"></i> Reply</h3>
            <div class="reply-context">
                <strong>Replying to: <span id="reply-to-name" style="color:var(--primary);">User</span></strong>
                <span id="reply-msg-preview" style="font-style:italic;">...</span>
            </div>
            <textarea id="reply-text" placeholder="Type your reply here..."></textarea>
            <button class="reply-btn-modal" onclick="sendReply()">Send Reply</button>
        </div>
    </div>

    <!-- Main Panel -->
    <div class="hidden" id="main-panel">
        <div class="header-bar">
            <button class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <div class="header-title" id="header-brand-text"></div>
        </div>

        <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
        <div class="sidebar" id="sidebar">
            <div class="brand" id="sidebar-brand"></div>
            <ul class="menu">
                <li onclick="showPage('stats')" id="nav-stats" class="active"><i class="fas fa-chart-pie"></i> Reports</li>
                <li onclick="showPage('apps')" id="nav-apps"><i class="fas fa-mobile-alt"></i> Manage Apps</li>
                <li onclick="showPage('community')" id="nav-community"><i class="fas fa-users"></i> Community</li>
                <li onclick="showPage('banners')" id="nav-banners"><i class="fas fa-images"></i> Banners</li>
                
                <!-- NEW SPONSOR ADS MENU -->
                <li onclick="showPage('sponsor-ads')" id="nav-sponsor-ads"><i class="fas fa-bullhorn"></i> Sponsor Ads</li>
                
                <li onclick="showPage('feed-ads')" id="nav-feed-ads"><i class="fas fa-ad"></i> In-Feed Ads</li>
                
                <!-- SPECIAL ADS MENU -->
                <li onclick="showPage('special-ads')" id="nav-special-ads"><i class="fas fa-window-restore"></i> Special Ads</li>

                <li onclick="showPage('approvals')" id="nav-approvals">
                    <i class="fas fa-check-double"></i> Approvals
                    <span id="approval-count" class="badge-count hidden">0</span>
                </li>
                <li onclick="showPage('settings')" id="nav-settings"><i class="fas fa-sliders-h"></i> Settings</li>
            </ul>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>

        <div class="main-content">
            
            <!-- REPORTS -->
            <div id="page-stats">
                <h3 style="margin-top:0;">Dashboard (UTC Time)</h3>
                
                <div class="stats-row">
                    <div class="stat-card">
                        <i class="fas fa-eye stat-icon c-blue"></i>
                        <div class="stat-title">Total Views</div>
                        <div class="stat-num" id="total-views">0</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-eye stat-icon c-blue"></i>
                        <div class="stat-title">Today Views</div>
                        <div class="stat-num" id="today-views">0</div>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <i class="fas fa-ad stat-icon c-orange"></i>
                        <div class="stat-title">Total Ads</div>
                        <div class="stat-num" id="total-ads">0</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-ad stat-icon c-orange"></i>
                        <div class="stat-title">Today Ads</div>
                        <div class="stat-num" id="today-ads">0</div>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <i class="fas fa-download stat-icon c-green"></i>
                        <div class="stat-title">Total DLs</div>
                        <div class="stat-num" id="total-dls">0</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-download stat-icon c-green"></i>
                        <div class="stat-title">Today DLs</div>
                        <div class="stat-num" id="today-dls">0</div>
                    </div>
                </div>

                <h3>Monthly Summary & Graph</h3>
                <div class="card">
                    <div id="monthly-summary-list" style="margin-bottom:20px; max-height:150px; overflow-y:auto; border:1px solid #eee; border-radius:6px;"></div>
                    <div class="chart-container">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>

                <h3>Daily History Logs</h3>
                <div class="card" style="padding:0; overflow-x:auto; max-height: 400px;">
                    <table id="history-table">
                        <thead>
                            <tr>
                                <th>Date (UTC)</th>
                                <th>Page Views</th>
                                <th>Downloads</th>
                                <th>Ads Watched</th>
                            </tr>
                        </thead>
                        <tbody id="history-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- MANAGE APPS -->
            <div id="page-apps" class="hidden">
                <div class="card">
                    <h3 id="form-title">Upload New App</h3>
                    <input type="hidden" id="edit-id">
                    
                    <div class="form-group">
                        <label>App Name</label>
                        <input type="text" id="app-name" class="form-control" placeholder="App Name">
                    </div>
                    <div class="form-group">
                        <label>Short Description</label>
                        <textarea id="app-desc" class="form-control" placeholder="Enter a short description about the app..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Version (e.g. v1.2.0)</label>
                        <input type="text" id="app-ver" class="form-control" placeholder="Version Number">
                    </div>

                    <div class="form-group">
                        <label>Category</label>
                        <!-- ADDED MUSIC CATEGORY HERE -->
                        <select id="app-cat-select" class="form-control" onchange="checkCustomCat()">
                            <option value="Movies">Movies</option>
                            <option value="Drama">Drama</option>
                            <option value="Music">Music</option> 
                            <option value="Games">Games</option>
                            <option value="Editing">Editing</option>
                            <option value="Video">Video</option>
                            <option value="Others">Others</option>
                            <option value="custom">+ Write Custom Category</option>
                        </select>
                        <input type="text" id="app-cat-custom" class="form-control hidden" style="margin-top:10px; border-color:var(--primary);" placeholder="Type category name here...">
                    </div>

                    <div class="form-group">
                        <label>Logo URL</label>
                        <input type="text" id="app-logo" class="form-control" placeholder="Image Link">
                    </div>
                    <div class="form-group">
                        <label>Download Link</label>
                        <input type="text" id="app-link" class="form-control" placeholder="File Link">
                    </div>

                    <button class="btn btn-success" onclick="saveApp()" id="btn-save"><i class="fas fa-upload"></i> Publish App</button>
                    <button class="btn btn-cancel hidden" onclick="resetForm()" id="btn-cancel">Cancel Edit</button>
                </div>

                <h3>App Library</h3>
                <div class="card" style="padding:0; overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>App Info</th>
                                <th>Stats (Likes/DLs)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="app-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- COMMUNITY SYSTEM -->
            <div id="page-community" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Community Chat</h3>
                    <button class="action-btn btn-del" onclick="cleanupOldMessages()" style="font-size:11px; width:auto; padding:8px 15px;">Force Cleanup</button>
                </div>
                <p style="font-size:12px; color:#636e72;">Auto-delete settings can be changed in "Settings".</p>
                <div class="card" style="padding:0; overflow-x:auto;">
                    <table id="comm-table">
                        <thead>
                            <tr>
                                <th>Message Content</th>
                                <th>Reactions</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="comm-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- BANNERS MANAGEMENT -->
            <div id="page-banners" class="hidden">
                <div class="card">
                    <h3 id="banner-form-title">Add Banner (Slider)</h3>
                    <p style="font-size:12px; color:#636e72; margin-bottom:10px;">Banners appear in "For You". Recommended Size: 320x100.</p>
                    <input type="hidden" id="banner-edit-id"> 
                    
                    <div class="form-group">
                        <label>Banner Image URL</label>
                        <input type="text" id="banner-img" class="form-control" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>Target URL (Action on click)</label>
                        <input type="text" id="banner-link" class="form-control" placeholder="https://...">
                    </div>
                    <button class="btn btn-success" id="btn-save-banner" onclick="addBanner()"><i class="fas fa-plus"></i> Add Banner</button>
                    <button class="btn btn-cancel hidden" id="btn-cancel-banner" onclick="resetBannerForm()">Cancel</button>
                </div>

                <h3>Active Banners</h3>
                <div class="card" style="padding:0; overflow-x:auto;">
                    <table class="spread-table">
                        <thead>
                            <tr>
                                <th>Preview</th>
                                <th>Link</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="banner-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- NEW: SPONSOR ADS MANAGEMENT -->
            <div id="page-sponsor-ads" class="hidden">
                <div class="card">
                    <h3 id="sponsor-form-title">Add Sponsor Ad</h3>
                    <p style="font-size:12px; color:#636e72; margin-bottom:10px;">Upload a square or rectangular image as an ad.</p>
                    <input type="hidden" id="sponsor-edit-id"> 
                    
                    <div class="form-group">
                        <label>Ad Name (For Admin Reference)</label>
                        <input type="text" id="sponsor-name" class="form-control" placeholder="e.g. 1xbet Promo">
                    </div>

                    <div class="form-group">
                        <label>Image Link (Banner URL)</label>
                        <input type="text" id="sponsor-img" class="form-control" placeholder="https://imgur.com/...">
                    </div>

                    <div class="form-group">
                        <label>Ad Link (Target URL)</label>
                        <input type="text" id="sponsor-link" class="form-control" placeholder="https://site.com/...">
                    </div>

                    <div class="form-group">
                        <label>Show After How Many Apps? (Position)</label>
                        <input type="number" id="sponsor-freq" class="form-control" placeholder="e.g. 4 (Means after 4th app)">
                        <p style="font-size:11px; color:#e17055; margin-top:5px;"><b>Note:</b> Even numbers (2, 4, 6, 8) are recommended.</p>
                    </div>

                    <button class="btn btn-success" id="btn-save-sponsor" onclick="addSponsorAd()"><i class="fas fa-plus"></i> Add Sponsor Ad</button>
                    <button class="btn btn-cancel hidden" id="btn-cancel-sponsor" onclick="resetSponsorForm()">Cancel</button>
                </div>

                <h3>Active Sponsor Ads</h3>
                <div class="card" style="padding:0; overflow-x:auto;">
                    <table class="spread-table">
                        <thead>
                            <tr>
                                <th>Preview</th>
                                <th>Name</th>
                                <th>Position</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="sponsor-ads-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- IN-FEED ADS MANAGEMENT -->
            <div id="page-feed-ads" class="hidden">
                <div class="card">
                    <h3 id="feed-form-title">Add In-Feed Banner Ad</h3>
                    <p style="font-size:12px; color:#636e72; margin-bottom:10px;">Supported: Adsterra, Advertica, HTML, Scripts.</p>
                    <input type="hidden" id="feed-edit-id"> 
                    
                    <div class="form-group">
                        <label>Ad Name (For Admin Reference)</label>
                        <input type="text" id="feed-ad-name" class="form-control" placeholder="e.g. Home Top Ad or Game Ad">
                    </div>

                    <div class="form-group">
                        <label>Ad Code (Paste Exact Script Here)</label>
                        <textarea id="feed-ad-code" class="form-control" style="height:150px; font-family:monospace; font-size:12px;" placeholder='<script src="..."></script> or <a href...>'></textarea>
                    </div>

                    <div class="form-group">
                        <label>Show After How Many Apps? (Position)</label>
                        <input type="number" id="feed-ad-freq" class="form-control" placeholder="e.g. 6 (Means after 6th app)">
                        <p style="font-size:11px; color:#e17055; margin-top:5px;"><b>Note:</b> Even numbers (2, 4, 6, 8, 10) are recommended.</p>
                    </div>

                    <button class="btn btn-success" id="btn-save-feed" onclick="addFeedAd()"><i class="fas fa-plus"></i> Add Banner Ad</button>
                    <button class="btn btn-cancel hidden" id="btn-cancel-feed" onclick="resetFeedForm()">Cancel</button>
                </div>

                <h3>Active In-Feed Ads</h3>
                <div class="card" style="padding:0; overflow-x:auto;">
                    <table class="spread-table">
                        <thead>
                            <tr>
                                <th>Ad Name</th>
                                <th>Position</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="feed-ads-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- SPECIAL ADS (POPUNDER, INTERSTITIAL) -->
            <div id="page-special-ads" class="hidden">
                <div class="card">
                    <h3 id="special-form-title">Add Special Ad</h3>
                    <p style="font-size:12px; color:#636e72; margin-bottom:10px;">For Onclick, Popunder, Interstitial, Vignette, etc. (Global Scripts)</p>
                    <input type="hidden" id="special-edit-id"> 
                    
                    <div class="form-group">
                        <label>Ad Name (For Admin Reference)</label>
                        <input type="text" id="special-ad-name" class="form-control" placeholder="e.g. Popunder Script">
                    </div>

                    <div class="form-group">
                        <label>Ad Type (Category)</label>
                        <select id="special-ad-type" class="form-control">
                            <option value="Interstitial">Interstitial</option>
                            <option value="Native Banner">Native Banner</option>
                            <option value="Social Bar">Social Bar</option>
                            <option value="Push Notification">Push Notification</option>
                            <option value="Onclick (Popunder)">Onclick (Popunder)</option>
                            <option value="Vignette Banner">Vignette Banner</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Ad Code / Script</label>
                        <textarea id="special-ad-code" class="form-control" style="height:150px; font-family:monospace; font-size:12px;" placeholder='<script>...</script>'></textarea>
                    </div>

                    <button class="btn btn-success" id="btn-save-special" onclick="addSpecialAd()"><i class="fas fa-plus"></i> Add Special Ad</button>
                    <button class="btn btn-cancel hidden" id="btn-cancel-special" onclick="resetSpecialForm()">Cancel</button>
                </div>

                <h3>Active Special Ads</h3>
                <div class="card" style="padding:0; overflow-x:auto;">
                    <table class="spread-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="special-ads-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- USER APPROVALS -->
            <div id="page-approvals" class="hidden">
                <h3>Pending User Submissions</h3>
                <p style="font-size:12px; color:#636e72;">Review, Edit & Approve apps submitted by users.</p>
                <div class="card" style="padding:0; overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>App Details</th>
                                <th>Submitted By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pending-list"></tbody>
                    </table>
                </div>

                <div class="section-header">Recently Approved User Apps</div>
                <div class="card" style="padding:0; overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>App Name</th>
                                <th>Uploader</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="approved-history-list">
                            <tr><td colspan="3" style="text-align:center; padding:15px;">No approved user apps yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SETTINGS -->
            <div id="page-settings" class="hidden">
                <div class="card">
                    <h3>Branding & Naming</h3>
                    <div class="form-group">
                        <label>App Name (Shown in Header & Title)</label>
                        <input type="text" id="setting-app-name" class="form-control" placeholder="e.g. Applen">
                    </div>
                    <div class="form-group">
                        <label>Admin Panel Title</label>
                        <input type="text" id="setting-admin-title" class="form-control" placeholder="e.g. Admin Panel">
                    </div>
                    
                    <div class="form-group">
                        <label>App Name Color (User Site)</label>
                        <input type="text" id="setting-app-color" class="form-control" placeholder="e.g. #000000 or red or rgb(0,0,0)">
                    </div>

                    <div class="form-group">
                        <label>App Name Font Size (px)</label>
                        <input type="number" id="setting-app-size" class="form-control" placeholder="e.g. 24">
                    </div>

                    <h3>Timing Settings</h3>
                    <div class="stats-row">
                        <div style="flex:1;">
                            <label>Loading Screen (Seconds)</label>
                            <input type="number" id="setting-load-time" class="form-control" placeholder="e.g. 2">
                        </div>
                        <div style="flex:1;">
                            <label>Banner Auto-Slide (Seconds)</label>
                            <input type="number" id="setting-banner-time" class="form-control" placeholder="e.g. 5">
                        </div>
                    </div>

                    <h3>Header & Logo</h3>
                    <div class="form-group">
                        <label>Header Branding Mode</label>
                        <select id="setting-header-mode" class="form-control">
                            <option value="text">Show App Name Text</option>
                            <option value="logo">Show Logo Image</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Site Logo URL (Also used as Favicon)</label>
                        <input type="text" id="setting-logo-url" class="form-control" placeholder="https://i.imgur.com/...">
                    </div>

                    <div class="stats-row">
                         <div style="flex:1;">
                            <label>Loading Logo Size (px)</label>
                            <input type="number" id="setting-logo-width" class="form-control" placeholder="e.g. 150">
                        </div>
                        <div style="flex:1;">
                            <label>Header Logo Width (px)</label>
                            <input type="number" id="setting-header-width" class="form-control" placeholder="e.g. 40">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Header Logo Position (Left Margin px)</label>
                        <input type="number" id="setting-header-margin" class="form-control" placeholder="e.g. 10 to move right">
                    </div>

                    <h3>General Settings</h3>
                    <div class="form-group">
                        <label>New App Badge Duration (Hours)</label>
                        <input type="number" id="setting-badge-duration" class="form-control" placeholder="Default: 48">
                    </div>

                    <div class="form-group">
                        <label>Telegram Channel Link</label>
                        <input type="text" id="setting-tg-link" class="form-control" placeholder="https://t.me/YourChannel">
                    </div>

                    <h3>User Upload Configuration</h3>
                    <div class="form-group">
                        <label>App Submission Icon Mode</label>
                        <select id="setting-upload-mode" class="form-control">
                            <option value="active">Active (Icon Shown & Submission Allowed)</option>
                            <option value="paused">Paused (Icon Shown but Submission Blocked)</option>
                            <option value="hidden">Hidden (Icon Removed)</option>
                        </select>
                    </div>

                    <h3>Ads & Features</h3>
                    <div class="form-group">
                        <label>Monetag Zone ID (Integer)</label>
                        <input type="number" id="setting-zone-id" class="form-control" placeholder="No Default ID">
                    </div>

                    <div class="form-group">
                        <label>Ads Required to Unlock App</label>
                        <input type="number" id="setting-ads" class="form-control" value="1">
                    </div>

                    <h3>Community System</h3>
                    <div class="form-group">
                        <label>Community System Mode</label>
                        <select id="setting-comm-mode" class="form-control">
                            <option value="active">Active (Visible & Chat Enabled)</option>
                            <option value="paused">Paused (Visible but Read-Only)</option>
                            <option value="hidden">Hidden (Icon Removed)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Auto-Delete Messages After (Days)</label>
                        <input type="number" id="setting-comm-days" class="form-control" placeholder="Default is 30 days">
                    </div>

                    <button class="btn btn-success" onclick="saveSettings()">Save All Settings</button>
                </div>
            </div>

        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyCTWDBdADMvMo3CbDzU5zx-PfgX7POWPGs",
  authDomain: "apk-41682.firebaseapp.com",
  databaseURL: "https://apk-41682-default-rtdb.firebaseio.com",
  projectId: "apk-41682",
  storageBucket: "apk-41682.firebasestorage.app",
  messagingSenderId: "726314444762",
  appId: "1:726314444762:web:c1e8e51e783e2add0502e3"
};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const today = new Date().toISOString().split('T')[0];

        const ALLOWED_ADMIN_UID = "7dT4LSbKwsXCLHooyFIMk3doZLe2";

        let pendingApprovalKey = null;
        let pendingUploaderName = "";
        let allFeedAds = {};
        let allSponsorAds = {}; // Store Sponsor Ads
        let allSpecialAds = {}; // Store Special Ads
        let globalHistoryData = [];
        let statsChart = null;

        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        auth.onAuthStateChanged(user => {
            if(user) {
                if(user.uid === ALLOWED_ADMIN_UID) {
                    document.getElementById('auth-overlay').classList.add('hidden');
                    document.getElementById('main-panel').classList.remove('hidden');
                    showPage('stats');
                    loadData();
                } else {
                    Swal.fire({
                        title: 'Access Denied', text: 'You do not have permission to access this panel.', icon: undefined,
                        width: '300px', confirmButtonColor: '#ff4757', customClass: { popup: 'custom-popup-small', title: 'custom-popup-title-small', content: 'custom-popup-content-small', confirmButton: 'custom-del-btn' }
                    }).then(() => auth.signOut());
                    document.getElementById('auth-overlay').classList.remove('hidden');
                    document.getElementById('main-panel').classList.add('hidden');
                }
            } else {
                document.getElementById('auth-overlay').classList.remove('hidden');
                document.getElementById('main-panel').classList.add('hidden');
                document.getElementById('loading-screen').style.display = 'none'; 
            }
        });

        function hideLoginError() { document.getElementById('login-error-text').style.display = 'none'; }

        function login() {
            const email = document.getElementById('email-input').value.trim();
            const pass = document.getElementById('pass-input').value.trim();
            if(!email || !pass) {
                document.getElementById('login-error-text').innerText = "Please enter email and password";
                document.getElementById('login-error-text').style.display = 'block';
                return;
            }
            document.getElementById('loading-screen').style.display = 'flex';
            auth.signInWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    if(userCredential.user.uid === ALLOWED_ADMIN_UID) {
                        document.getElementById('auth-overlay').classList.add('hidden');
                        document.getElementById('main-panel').classList.remove('hidden');
                        document.getElementById('loading-screen').style.display = 'none';
                        showPage('stats');
                        loadData();
                    }
                })
                .catch(err => {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('login-error-text').innerText = "Incorrect Email or Password";
                    document.getElementById('login-error-text').style.display = 'block';
                    // SweetAlert2 পপআপটি (Login Failed) এখান থেকে সরানো হয়েছে
                });
        }

        function logout() { 
            Swal.fire({
                title: 'Logging Out?', text: "Are you sure you want to exit?", icon: undefined, width: '300px', showCancelButton: true, confirmButtonText: 'Yes, Logout', cancelButtonText: 'Cancel', buttonsStyling: false, customClass: { popup: 'custom-popup-small', title: 'custom-popup-title-small', content: 'custom-popup-content-small', confirmButton: 'custom-del-btn', cancelButton: 'custom-cancel-btn' }
            }).then((result) => { if (result.isConfirmed) { auth.signOut(); } })
        }

        function showToast(msg, type = "success") {
            const box = document.getElementById('toast-box');
            const icon = document.getElementById('toast-icon');
            const text = document.getElementById('toast-msg');
            text.innerText = msg;
            if(type === "delete") { icon.className = "fas fa-trash-alt"; icon.style.color = "#ff7675"; } 
            else if(type === "error") { icon.className = "fas fa-exclamation-circle"; icon.style.color = "#ff7675"; } 
            else { icon.className = "fas fa-check-circle"; icon.style.color = "#00C853"; }
            box.classList.add('show'); setTimeout(() => box.classList.remove('show'), 3000);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').style.display = (document.getElementById('overlay').style.display === 'block') ? 'none' : 'block';
        }

        function showPage(pageId) {
            ['stats', 'apps', 'community', 'settings', 'approvals', 'banners', 'feed-ads', 'sponsor-ads', 'special-ads'].forEach(p => {
                document.getElementById('page-'+p).classList.add('hidden');
                document.getElementById('nav-'+p).classList.remove('active');
            });
            document.getElementById('page-'+pageId).classList.remove('hidden');
            document.getElementById('nav-'+pageId).classList.add('active');
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').style.display = 'none';
        }

        function checkCustomCat() {
            const select = document.getElementById('app-cat-select');
            const input = document.getElementById('app-cat-custom');
            if(select.value === 'custom') { input.classList.remove('hidden'); input.focus(); } else { input.classList.add('hidden'); }
        }

        function updateText(id, newVal) { const el = document.getElementById(id); if(el && el.innerText != newVal) el.innerText = newVal; }
        function getAvatarColor(name) {
            const colors = ['#e17055', '#0984e3', '#00b894', '#6c5ce7', '#fdcb6e', '#d63031', '#00cec9', '#e84393'];
            let hash = 0; for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }

        function loadData() {
            db.ref('stats/total').on('value', snap => { const s = snap.val() || {}; updateText('total-views', s.views || 0); updateText('total-dls', s.downloads || 0); updateText('total-ads', s.ads || 0); });
            db.ref(`stats/daily/${today}`).on('value', snap => { const s = snap.val() || {}; updateText('today-views', s.views || 0); updateText('today-dls', s.downloads || 0); updateText('today-ads', s.ads || 0); });
            
            db.ref('stats/daily').on('value', snap => {
                const list = document.getElementById('history-list'); const data = snap.val() || {};
                globalHistoryData = Object.entries(data).map(([d, s]) => ({ date:d, ...s })).sort((a,b)=>new Date(b.date)-new Date(a.date));
                list.innerHTML = globalHistoryData.length ? '' : '<tr><td colspan="4" style="text-align:center;">No history</td></tr>';
                globalHistoryData.forEach(row => list.innerHTML += `<tr><td style="color:var(--primary);font-weight:bold;font-family:monospace;">${row.date}</td><td>${row.views||0}</td><td>${row.downloads||0}</td><td>${row.ads||0}</td></tr>`);
                processMonthlyStats();
            });

            db.ref('apps').on('value', snap => {
                const list = document.getElementById('app-list'); const approvedHistory = document.getElementById('approved-history-list'); const data = snap.val();
                if(!data) { list.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">No apps found</td></tr>'; approvedHistory.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:15px;">No approved user apps yet.</td></tr>'; return; }
                list.innerHTML = ""; approvedHistory.innerHTML = ""; let hasApprovedUserApps = false;
                Object.entries(data).sort((a,b)=>(b[1].timestamp||0)-(a[1].timestamp||0)).forEach(([key, app]) => {
                    let safeName = (app.name || '').replace(/'/g, "\\'");
                    list.innerHTML += `<tr><td><div style="display:flex;align-items:center;gap:10px;"><img src="${app.logo}" class="t-img" onerror="this.src='https://placehold.co/40'"><div><div style="font-weight:600;">${app.name} <span class="badge-ver">${app.version||'v1.0'}</span></div><small style="color:#777">${app.category}</small></div></div></td><td><div class="likes-count"><i class="fas fa-heart"></i> ${app.likes||0}</div><br><small>${app.downloads||0} Downloads</small></td><td><button class="action-btn btn-edit" onclick="editApp('${key}','${safeName}','${app.category}','${app.logo}','${app.link}','${app.version||''}','${app.description||''}')"><i class="fas fa-pen"></i></button><button class="action-btn btn-del" onclick="delApp('${key}', '${safeName}')"><i class="fas fa-trash"></i></button></td></tr>`;
                    if(app.uploader) { hasApprovedUserApps = true; approvedHistory.innerHTML += `<tr><td><div style="display:flex;align-items:center;gap:10px;"><img src="${app.logo}" class="t-img" onerror="this.src='https://placehold.co/40'"><div style="font-weight:600;">${app.name}</div></div></td><td>${app.uploader}</td><td><span style="color:#00b894; font-weight:bold; font-size:12px;"><i class="fas fa-check-circle"></i> Live</span></td></tr>`; }
                });
                if(!hasApprovedUserApps) approvedHistory.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:15px;">No approved user apps yet.</td></tr>';
            });

            db.ref('pending_apps').on('value', snap => {
                const list = document.getElementById('pending-list'); const badge = document.getElementById('approval-count'); const data = snap.val();
                const count = data ? Object.keys(data).length : 0;
                badge.innerText = count > 0 ? count : ""; badge.classList.toggle('hidden', count === 0);
                if(!data) { list.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">No pending submissions</td></tr>'; return; }
                list.innerHTML = "";
                Object.entries(data).forEach(([key, app]) => {
                    let safeName = (app.name || '').replace(/'/g, "\\'"); let safeUploader = (app.uploader || 'Anonymous').replace(/'/g, "\\'");
                    list.innerHTML += `<tr><td><div style="display:flex;align-items:center;gap:10px;"><img src="${app.logo}" class="t-img" onerror="this.src='https://placehold.co/40'"><div><div style="font-weight:600;">${app.name} <span class="badge-pending">v${app.version||'1.0'}</span></div><small style="color:#777">${app.category}</small><div style="font-size:11px; margin-top:2px; color:#0984e3;"><a href="${app.link}" target="_blank">View File Link</a></div></div></div></td><td>${app.uploader || 'Anonymous User'}</td><td><button class="action-btn btn-approve" onclick="prepareApprove('${key}', '${safeName}', '${app.category}', '${app.logo}', '${app.link}', '${app.version||''}', '${app.description||''}', '${safeUploader}')"><i class="fas fa-edit"></i> Approve</button><button class="action-btn btn-del" onclick="rejectApp('${key}')"><i class="fas fa-times"></i></button></td></tr>`;
                });
            });

            db.ref('banners').on('value', snap => {
                const list = document.getElementById('banner-list'); const data = snap.val();
                if(!data) { list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:15px;">No banners added</td></tr>'; return; }
                list.innerHTML = "";
                Object.entries(data).forEach(([key, b]) => {
                    const btnClass = b.active ? 'btn-toggle-on' : 'btn-toggle-off'; const icon = b.active ? 'fa-toggle-on' : 'fa-toggle-off';
                    list.innerHTML += `<tr><td><img src="${b.img}" class="banner-preview" onclick="window.open('${b.img}')" style="cursor:pointer;"></td><td><a href="${b.link}" target="_blank" style="font-size:12px;color:#0984e3;">Link</a></td><td><button class="action-btn ${btnClass}" onclick="toggleBanner('${key}', ${b.active})"><i class="fas ${icon}"></i></button></td><td style="white-space:nowrap;"><button class="action-btn btn-edit" onclick="editBanner('${key}', '${b.img}', '${b.link}')"><i class="fas fa-pen"></i></button><button class="action-btn btn-del" onclick="deleteBanner('${key}')"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            });

            // FEED ADS LISTENER
            db.ref('feed_ads').on('value', snap => {
                const list = document.getElementById('feed-ads-list'); const data = snap.val(); allFeedAds = data || {};
                if(!data) { list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:15px;">No in-feed ads added</td></tr>'; return; }
                list.innerHTML = "";
                Object.entries(data).forEach(([key, ad]) => {
                    const btnClass = ad.active ? 'btn-toggle-on' : 'btn-toggle-off'; const icon = ad.active ? 'fa-toggle-on' : 'fa-toggle-off'; let safeName = (ad.name || 'Unnamed Ad').replace(/'/g, "\\'");
                    list.innerHTML += `<tr><td><div class="ad-name-badge">${ad.name || 'Unnamed Ad'}</div></td><td>After <b>${ad.position}</b> Apps</td><td><button class="action-btn ${btnClass}" onclick="toggleFeedAd('${key}', ${ad.active})"><i class="fas ${icon}"></i></button></td><td style="white-space:nowrap;"><button class="action-btn btn-edit" onclick="editFeedAd('${key}')"><i class="fas fa-pen"></i></button><button class="action-btn btn-del" onclick="deleteFeedAd('${key}', '${safeName}')"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            });

            // SPONSOR ADS LISTENER
            db.ref('sponsor_ads').on('value', snap => {
                const list = document.getElementById('sponsor-ads-list'); const data = snap.val(); allSponsorAds = data || {};
                if(!data) { list.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:15px;">No sponsor ads added</td></tr>'; return; }
                list.innerHTML = "";
                Object.entries(data).forEach(([key, ad]) => {
                    const btnClass = ad.active ? 'btn-toggle-on' : 'btn-toggle-off'; const icon = ad.active ? 'fa-toggle-on' : 'fa-toggle-off'; let safeName = (ad.name || 'Unnamed').replace(/'/g, "\\'");
                    list.innerHTML += `<tr>
                        <td><img src="${ad.img}" class="sponsor-preview" onclick="window.open('${ad.img}')" style="cursor:pointer;"></td>
                        <td><div class="ad-name-badge">${ad.name || 'Unnamed'}</div></td>
                        <td>After <b>${ad.position}</b> Apps</td>
                        <td><button class="action-btn ${btnClass}" onclick="toggleSponsorAd('${key}', ${ad.active})"><i class="fas ${icon}"></i></button></td>
                        <td style="white-space:nowrap;"><button class="action-btn btn-edit" onclick="editSponsorAd('${key}')"><i class="fas fa-pen"></i></button><button class="action-btn btn-del" onclick="deleteSponsorAd('${key}', '${safeName}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                });
            });

            // SPECIAL ADS LISTENER
            db.ref('special_ads').on('value', snap => {
                const list = document.getElementById('special-ads-list'); const data = snap.val(); allSpecialAds = data || {};
                if(!data) { list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:15px;">No special ads added</td></tr>'; return; }
                list.innerHTML = "";
                Object.entries(data).forEach(([key, ad]) => {
                    const btnClass = ad.active ? 'btn-toggle-on' : 'btn-toggle-off'; const icon = ad.active ? 'fa-toggle-on' : 'fa-toggle-off'; let safeName = (ad.name || 'Unnamed').replace(/'/g, "\\'");
                    list.innerHTML += `<tr>
                        <td><div class="ad-name-badge">${ad.name || 'Unnamed'}</div></td>
                        <td>${ad.type || 'Script'}</td>
                        <td><button class="action-btn ${btnClass}" onclick="toggleSpecialAd('${key}', ${ad.active})"><i class="fas ${icon}"></i></button></td>
                        <td style="white-space:nowrap;"><button class="action-btn btn-edit" onclick="editSpecialAd('${key}')"><i class="fas fa-pen"></i></button><button class="action-btn btn-del" onclick="deleteSpecialAd('${key}', '${safeName}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                });
            });

            db.ref('community').on('value', snap => {
                const list = document.getElementById('comm-list'); const data = snap.val();
                if(!data) { list.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:15px;">No messages</td></tr>'; return; }
                list.innerHTML = '';
                Object.entries(data).sort((a,b)=>(b[1].timestamp||0)-(a[1].timestamp||0)).forEach(([key, msg]) => {
                    let safeUser = (msg.username || 'User').replace(/'/g, "\\'"); let safeMsg = (msg.text || '').replace(/'/g, "\\'"); let firstLetter = (msg.username || "A").charAt(0).toUpperCase(); let color = getAvatarColor(msg.username || "User");
                    list.innerHTML += `<tr><td><div class="comm-user-flex"><div class="comm-avatar" style="background:${color};">${firstLetter}</div><span class="req-name">${msg.username||'Anon'}</span></div><div class="req-msg">${msg.text}</div><small style="color:#777; font-size:10px;"><i class="far fa-clock"></i> ${new Date(msg.timestamp).toLocaleString()}</small>${msg.adminReply ? `<div class="admin-reply-box"><b>You:</b> ${msg.adminReply}</div>` : ''}<div><button class="btn-reply-small" onclick="openReplyModal('${key}', '${safeUser}', '${safeMsg}')"><i class="fas fa-reply"></i> Reply</button></div></td><td style="text-align:center; vertical-align:middle;"><div style="font-weight:bold; color:#ff7675; font-size:13px;"><i class="fas fa-heart"></i> ${msg.reactions?Object.keys(msg.reactions).length:0}</div></td><td style="width:80px; text-align:center; vertical-align:middle;"><button class="action-btn btn-del" onclick="delMsg('${key}', '${safeMsg}')"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            });

            db.ref('settings').on('value', s => { 
                const data = s.val() || {};
                document.getElementById('setting-load-time').value = data.loadingDuration || 2; document.getElementById('setting-banner-time').value = data.bannerInterval || 5; document.getElementById('setting-header-mode').value = data.headerMode || 'text'; document.getElementById('setting-logo-url').value = data.siteLogo || ""; document.getElementById('setting-logo-width').value = data.logoWidth || ""; document.getElementById('setting-header-width').value = data.headerLogoWidth || ""; document.getElementById('setting-header-margin').value = data.headerLogoMargin || ""; document.getElementById('setting-ads').value = data.adsCount || 1; document.getElementById('setting-comm-mode').value = data.communityMode || 'active'; document.getElementById('setting-upload-mode').value = data.uploadMode || 'active'; document.getElementById('setting-zone-id').value = data.monetagZoneId || ""; document.getElementById('setting-tg-link').value = data.telegramLink || ""; document.getElementById('setting-comm-days').value = data.autoDeleteDays || 30; document.getElementById('setting-badge-duration').value = data.newBadgeDuration || 48; document.getElementById('setting-app-name').value = data.appName || ""; document.getElementById('setting-admin-title').value = data.adminTitle || ""; document.getElementById('setting-app-color').value = data.appNameColor || ""; document.getElementById('setting-app-size').value = data.appNameFontSize || "";
                if(data.adminTitle) document.title = data.adminTitle;
                const appName = data.appName || ""; const headerTitle = document.getElementById('header-brand-text'); const sidebarBrand = document.getElementById('sidebar-brand');
                headerTitle.innerText = appName ? appName + " Admin" : "Admin Panel"; sidebarBrand.innerHTML = appName + "<span> Admin</span>";
                if(data.appNameColor) headerTitle.style.color = data.appNameColor;
                if(data.appNameFontSize) headerTitle.style.fontSize = data.appNameFontSize + 'px';
                if(data.siteLogo) document.getElementById('dynamic-favicon').href = data.siteLogo;
                const loaderImg = document.getElementById('admin-loader-img'); const loadTime = (data.loadingDuration || 2) * 1000;
                if(data.siteLogo) { loaderImg.src = data.siteLogo; loaderImg.style.display = 'block'; if(data.logoWidth) loaderImg.style.width = data.logoWidth + "px"; }
                if(!window.adminLoaded) { setTimeout(() => { document.getElementById('loading-screen').style.display = 'none'; window.adminLoaded = true; }, loadTime); }
            });
        }

        function processMonthlyStats() {
            const monthlyData = {};
            globalHistoryData.forEach(item => {
                const monthKey = item.date.slice(0, 7);
                if (!monthlyData[monthKey]) { monthlyData[monthKey] = { views: 0, ads: 0, dls: 0, key: monthKey }; }
                monthlyData[monthKey].views += (item.views || 0); monthlyData[monthKey].ads += (item.ads || 0); monthlyData[monthKey].dls += (item.downloads || 0);
            });
            const listContainer = document.getElementById('monthly-summary-list'); listContainer.innerHTML = "";
            const monthsArr = Object.values(monthlyData).sort((a,b) => b.key.localeCompare(a.key));
            if(monthsArr.length === 0) { listContainer.innerHTML = "<div style='padding:10px;text-align:center;'>No data yet.</div>"; return; }
            const currentMonthKey = new Date().toISOString().slice(0, 7);
            monthsArr.forEach(m => {
                const dateObj = new Date(m.key + "-01"); const monthName = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' }); const isCurrent = m.key === currentMonthKey;
                const div = document.createElement('div'); div.className = `monthly-item ${isCurrent ? 'active' : ''}`;
                div.innerHTML = `<div class="m-title">${monthName}</div><div class="m-stats"><div class="m-stat"><i class="fas fa-eye"></i> <span>${m.views}</span></div><div class="m-stat"><i class="fas fa-ad"></i> <span>${m.ads}</span></div><div class="m-stat"><i class="fas fa-download"></i> <span>${m.dls}</span></div></div>`;
                div.onclick = () => { document.querySelectorAll('.monthly-item').forEach(el => el.classList.remove('active')); div.classList.add('active'); filterChartByMonth(m.key); };
                listContainer.appendChild(div);
            });
            filterChartByMonth(currentMonthKey);
        }

        function filterChartByMonth(monthKey) {
            const filteredData = globalHistoryData.filter(item => item.date.startsWith(monthKey));
            const graphData = filteredData.sort((a,b) => new Date(a.date) - new Date(b.date));
            renderChart(graphData);
        }

        function renderChart(dataArr) {
            const labels = dataArr.map(d => d.date.split('-')[2]); const views = dataArr.map(d => d.views || 0); const downloads = dataArr.map(d => d.downloads || 0); const ads = dataArr.map(d => d.ads || 0);
            const ctx = document.getElementById('statsChart').getContext('2d');
            if(statsChart) { statsChart.data.labels = labels; statsChart.data.datasets[0].data = views; statsChart.data.datasets[1].data = downloads; statsChart.data.datasets[2].data = ads; statsChart.update('none'); return; }
            statsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Page Views', data: views, borderColor: '#0984e3', backgroundColor: 'rgba(9, 132, 227, 0.1)', borderWidth: 2, tension: 0.3, fill: true },
                        { label: 'Downloads', data: downloads, borderColor: '#00b894', backgroundColor: 'rgba(0, 184, 148, 0.1)', borderWidth: 2, tension: 0.3, fill: true },
                        { label: 'Ads Watched', data: ads, borderColor: '#e17055', backgroundColor: 'rgba(225, 112, 85, 0.1)', borderWidth: 2, tension: 0.3, fill: true }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { title: (context) => "Date: " + context[0].label } } }, scales: { y: { beginAtZero: true, grid: { color: '#f1f2f6' } }, x: { grid: { display: false } } } }
            });
        }

        let currentReplyKey = null;
        function openReplyModal(key, username, msgText) { currentReplyKey = key; document.getElementById('reply-to-name').innerText = username; document.getElementById('reply-msg-preview').innerText = `"${msgText}"`; document.getElementById('reply-text').value = ""; document.getElementById('reply-overlay').classList.remove('hidden'); document.getElementById('reply-text').focus(); }
        function closeReply() { document.getElementById('reply-overlay').classList.add('hidden'); currentReplyKey = null; }
        function sendReply() { if(!currentReplyKey) return; const text = document.getElementById('reply-text').value.trim(); if(!text) return showToast("Please write a reply", "error"); db.ref('community/'+currentReplyKey).update({adminReply: text}).then(() => { showToast("Reply Sent!", "success"); closeReply(); }); }

        function delApp(key, appName) { Swal.fire({ title: 'Delete App?', html: `<p style="font-size:13px; color:#636e72; margin:0;">Are you sure you want to remove <br><b style="color:#2d3436; font-size:14px;">${appName}</b>?</p>`, width: '320px', showCancelButton: true, confirmButtonText: 'Yes, Delete', cancelButtonText: 'Cancel', reverseButtons: true, backdrop: false, buttonsStyling: false, customClass: { popup: 'custom-delete-popup', confirmButton: 'custom-del-btn', cancelButton: 'custom-cancel-btn', title: 'custom-del-title' } }).then((result) => { if (result.isConfirmed) { db.ref('apps/'+key).remove(); showToast("App Deleted Successfully", "delete"); } }) }
        function prepareApprove(key, name, cat, logo, link, ver, desc, uploader) { pendingApprovalKey = key; pendingUploaderName = uploader; document.getElementById('edit-id').value = ''; document.getElementById('app-name').value = name; document.getElementById('app-desc').value = desc || ""; document.getElementById('app-logo').value = logo; document.getElementById('app-link').value = link; document.getElementById('app-ver').value = ver; const select = document.getElementById('app-cat-select'); const customInput = document.getElementById('app-cat-custom'); if(Array.from(select.options).map(o=>o.value).includes(cat)) { select.value = cat; customInput.classList.add('hidden'); } else { select.value = 'custom'; customInput.value = cat; customInput.classList.remove('hidden'); } document.getElementById('form-title').innerText = "Review & Approve App"; document.getElementById('btn-save').innerHTML = "<i class='fas fa-check-circle'></i> Approve & Publish"; document.getElementById('btn-cancel').classList.remove('hidden'); showPage('apps'); window.scrollTo(0,0); }
        function rejectApp(key) { Swal.fire({ title: 'Reject Submission?', html: `<p style="font-size:13px; color:#636e72; margin:0;">Are you sure you want to reject and delete this user submission?</p>`, width: '320px', showCancelButton: true, confirmButtonText: 'Yes, Reject', cancelButtonText: 'Cancel', reverseButtons: true, backdrop: false, buttonsStyling: false, icon: undefined, customClass: { popup: 'custom-delete-popup', confirmButton: 'custom-del-btn', cancelButton: 'custom-cancel-btn', title: 'custom-del-title' } }).then((result) => { if (result.isConfirmed) { db.ref('pending_apps/'+key).remove(); showToast("Submission Rejected", "delete"); } }) }
        function delMsg(key, msgContent) { let preview = msgContent.length > 30 ? msgContent.substring(0, 30) + '...' : msgContent; Swal.fire({ title: 'Delete Message?', html: `<div style="font-size:13px; color:#636e72; background:#f1f2f6; padding:8px; border-radius:6px; margin-top:5px;">"${preview}"</div>`, width: '320px', showCancelButton: true, confirmButtonText: 'Delete', cancelButtonText: 'Cancel', reverseButtons: true, backdrop: false, buttonsStyling: false, customClass: { popup: 'custom-delete-popup', confirmButton: 'custom-del-btn', cancelButton: 'custom-cancel-btn', title: 'custom-del-title' } }).then((result) => { if (result.isConfirmed) { db.ref('community/'+key).remove(); showToast("Message Deleted Successfully", "delete"); } }) }

        function addBanner() { const img = document.getElementById('banner-img').value.trim(); const link = document.getElementById('banner-link').value.trim(); const editId = document.getElementById('banner-edit-id').value; if(!img) return showToast("Image URL is required", "error"); const data = { img: img, link: link || '#', active: true, timestamp: firebase.database.ServerValue.TIMESTAMP }; if(editId) { db.ref('banners/'+editId).update(data).then(() => { showToast("Banner Updated", "success"); resetBannerForm(); }); } else { db.ref('banners').push(data).then(() => { showToast("Banner Added", "success"); resetBannerForm(); }); } }
        function editBanner(key, img, link) { document.getElementById('banner-img').value = img; document.getElementById('banner-link').value = link; document.getElementById('banner-edit-id').value = key; document.getElementById('banner-form-title').innerText = "Edit Banner"; document.getElementById('btn-save-banner').innerHTML = "<i class='fas fa-save'></i> Update Banner"; document.getElementById('btn-cancel-banner').classList.remove('hidden'); window.scrollTo(0,0); }
        function resetBannerForm() { document.getElementById('banner-img').value = ""; document.getElementById('banner-link').value = ""; document.getElementById('banner-edit-id').value = ""; document.getElementById('banner-form-title').innerText = "Add Banner (Slider)"; document.getElementById('btn-save-banner').innerHTML = "<i class='fas fa-plus'></i> Add Banner"; document.getElementById('btn-cancel-banner').classList.add('hidden'); }
        function toggleBanner(key, currentStatus) { db.ref('banners/'+key).update({ active: !currentStatus }); }
        function deleteBanner(key) { Swal.fire({ title: 'Delete Banner?', html: `<p style="font-size:13px; color:#636e72; margin:0;">This slider image will be permanently removed.</p>`, width: '320px', showCancelButton: true, confirmButtonText: 'Yes, Delete', cancelButtonText: 'Cancel', reverseButtons: true, backdrop: false, buttonsStyling: false, customClass: { popup: 'custom-delete-popup', confirmButton: 'custom-del-btn', cancelButton: 'custom-cancel-btn', title: 'custom-del-title' } }).then((result) => { if (result.isConfirmed) { db.ref('banners/'+key).remove(); showToast("Banner Removed", "delete"); resetBannerForm(); } }) }

        // --- SPONSOR ADS FUNCTIONS ---
        function addSponsorAd() {
            const name = document.getElementById('sponsor-name').value.trim();
            const img = document.getElementById('sponsor-img').value.trim();
            const link = document.getElementById('sponsor-link').value.trim();
            const pos = parseInt(document.getElementById('sponsor-freq').value);
            const editId = document.getElementById('sponsor-edit-id').value;

            if(!img || !pos || !name || !link) return showToast("Please fill all fields", "error");
            if(pos % 2 !== 0) return showToast("Position must be an EVEN number (2, 4, 6...)", "error");

            const data = { name: name, img: img, link: link, position: pos, active: true, timestamp: firebase.database.ServerValue.TIMESTAMP };
            
            if(editId) { 
                db.ref('sponsor_ads/'+editId).update(data).then(() => { showToast("Sponsor Ad Updated", "success"); resetSponsorForm(); });
            } else { 
                db.ref('sponsor_ads').push(data).then(() => { showToast("Sponsor Ad Added", "success"); resetSponsorForm(); }); 
            }
        }

        function editSponsorAd(key) {
            const ad = allSponsorAds[key]; if(!ad) return showToast("Error loading ad", "error");
            document.getElementById('sponsor-name').value = ad.name || ""; 
            document.getElementById('sponsor-img').value = ad.img; 
            document.getElementById('sponsor-link').value = ad.link;
            document.getElementById('sponsor-freq').value = ad.position; 
            document.getElementById('sponsor-edit-id').value = key;
            document.getElementById('sponsor-form-title').innerText = "Edit Sponsor Ad"; 
            document.getElementById('btn-save-sponsor').innerHTML = "<i class='fas fa-save'></i> Update Sponsor Ad"; 
            document.getElementById('btn-cancel-sponsor').classList.remove('hidden'); 
            window.scrollTo(0,0);
        }

        function resetSponsorForm() {
            document.getElementById('sponsor-name').value = ""; document.getElementById('sponsor-img').value = ""; 
            document.getElementById('sponsor-link').value = ""; document.getElementById('sponsor-freq').value = ""; 
            document.getElementById('sponsor-edit-id').value = "";
            document.getElementById('sponsor-form-title').innerText = "Add Sponsor Ad"; 
            document.getElementById('btn-save-sponsor').innerHTML = "<i class='fas fa-plus'></i> Add Sponsor Ad"; 
            document.getElementById('btn-cancel-sponsor').classList.add('hidden');
        }

        function toggleSponsorAd(key, currentStatus) { db.ref('sponsor_ads/'+key).update({ active: !currentStatus }); }

        function deleteSponsorAd(key, adName) {
            Swal.fire({
                title: 'Delete Ad?', html: `<p style="font-size:13px; color:#636e72; margin:0;">Remove sponsor ad: <br><b style="color:#2d3436; font-size:14px;">${adName}</b>?</p>`,
                width: '320px', showCancelButton: true, confirmButtonText: 'Yes, Delete', cancelButtonText: 'Cancel', reverseButtons: true, backdrop: false, buttonsStyling: false,
                customClass: { popup: 'custom-delete-popup', confirmButton: 'custom-del-btn', cancelButton: 'custom-cancel-btn', title: 'custom-del-title' }
            }).then((result) => { if (result.isConfirmed) { db.ref('sponsor_ads/'+key).remove(); showToast("Ad Deleted", "delete"); resetSponsorForm(); } })
        }

        // --- FEED ADS FUNCTIONS ---
        function addFeedAd() {
            const name = document.getElementById('feed-ad-name').value.trim(); const code = document.getElementById('feed-ad-code').value.trim(); const pos = parseInt(document.getElementById('feed-ad-freq').value); const editId = document.getElementById('feed-edit-id').value;
            if(!code || !pos || !name) return showToast("Please fill all fields", "error");
            if(pos % 2 !== 0) return showToast("Position must be an EVEN number (2, 4, 6...)", "error");
            const data = { name: name, code: code, position: pos, active: true, timestamp: firebase.database.ServerValue.TIMESTAMP };
            if(editId) { db.ref('feed_ads/'+editId).update(data).then(() => { showToast("In-Feed Ad Updated", "success"); resetFeedForm(); }); } else { db.ref('feed_ads').push(data).then(() => { showToast("In-Feed Ad Added", "success"); resetFeedForm(); }); }
        }
        function editFeedAd(key) { const ad = allFeedAds[key]; if(!ad) return showToast("Error loading ad data", "error"); document.getElementById('feed-ad-name').value = ad.name || ""; document.getElementById('feed-ad-code').value = ad.code; document.getElementById('feed-ad-freq').value = ad.position; document.getElementById('feed-edit-id').value = key; document.getElementById('feed-form-title').innerText = "Edit In-Feed Ad"; document.getElementById('btn-save-feed').innerHTML = "<i class='fas fa-save'></i> Update Ad"; document.getElementById('btn-cancel-feed').classList.remove('hidden'); window.scrollTo(0,0); }
        function resetFeedForm() { document.getElementById('feed-ad-name').value = ""; document.getElementById('feed-ad-code').value = ""; document.getElementById('feed-ad-freq').value = ""; document.getElementById('feed-edit-id').value = ""; document.getElementById('feed-form-title').innerText = "Add In-Feed Banner Ad"; document.getElementById('btn-save-feed').innerHTML = "<i class='fas fa-plus'></i> Add Banner Ad"; document.getElementById('btn-cancel-feed').classList.add('hidden'); }
        function toggleFeedAd(key, currentStatus) { db.ref('feed_ads/'+key).update({ active: !currentStatus }); }
        function deleteFeedAd(key, adName) { Swal.fire({ title: 'Delete Ad?', html: `<p style="font-size:13px; color:#636e72; margin:0;">Are you sure you want to remove <br><b style="color:#2d3436; font-size:14px;">${adName}</b>?</p>`, width: '320px', showCancelButton: true, confirmButtonText: 'Yes, Delete', cancelButtonText: 'Cancel', reverseButtons: true, backdrop: false, buttonsStyling: false, customClass: { popup: 'custom-delete-popup', confirmButton: 'custom-del-btn', cancelButton: 'custom-cancel-btn', title: 'custom-del-title' } }).then((result) => { if (result.isConfirmed) { db.ref('feed_ads/'+key).remove(); showToast("Ad Deleted", "delete"); resetFeedForm(); } }) }

        // --- SPECIAL ADS FUNCTIONS ---
        function addSpecialAd() {
            const name = document.getElementById('special-ad-name').value.trim();
            const type = document.getElementById('special-ad-type').value;
            const code = document.getElementById('special-ad-code').value.trim();
            const editId = document.getElementById('special-edit-id').value;

            if(!name || !code) return showToast("Please fill all fields", "error");

            const data = { name: name, type: type, code: code, active: true, timestamp: firebase.database.ServerValue.TIMESTAMP };

            if(editId) {
                db.ref('special_ads/'+editId).update(data).then(() => { showToast("Special Ad Updated", "success"); resetSpecialForm(); });
            } else {
                db.ref('special_ads').push(data).then(() => { showToast("Special Ad Added", "success"); resetSpecialForm(); });
            }
        }

        function editSpecialAd(key) {
            const ad = allSpecialAds[key]; if(!ad) return showToast("Error loading ad", "error");
            document.getElementById('special-ad-name').value = ad.name || "";
            document.getElementById('special-ad-type').value = ad.type || "Interstitial";
            document.getElementById('special-ad-code').value = ad.code || "";
            document.getElementById('special-edit-id').value = key;
            document.getElementById('special-form-title').innerText = "Edit Special Ad";
            document.getElementById('btn-save-special').innerHTML = "<i class='fas fa-save'></i> Update Special Ad";
            document.getElementById('btn-cancel-special').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function resetSpecialForm() {
            document.getElementById('special-ad-name').value = "";
            document.getElementById('special-ad-type').value = "Interstitial";
            document.getElementById('special-ad-code').value = "";
            document.getElementById('special-edit-id').value = "";
            document.getElementById('special-form-title').innerText = "Add Special Ad";
            document.getElementById('btn-save-special').innerHTML = "<i class='fas fa-plus'></i> Add Special Ad";
            document.getElementById('btn-cancel-special').classList.add('hidden');
        }

        function toggleSpecialAd(key, currentStatus) { db.ref('special_ads/'+key).update({ active: !currentStatus }); }

        function deleteSpecialAd(key, adName) {
            Swal.fire({
                title: 'Delete Ad?', html: `<p style="font-size:13px; color:#636e72; margin:0;">Remove special ad: <br><b style="color:#2d3436; font-size:14px;">${adName}</b>?</p>`,
                width: '320px', showCancelButton: true, confirmButtonText: 'Yes, Delete', cancelButtonText: 'Cancel', reverseButtons: true, backdrop: false, buttonsStyling: false,
                customClass: { popup: 'custom-delete-popup', confirmButton: 'custom-del-btn', cancelButton: 'custom-cancel-btn', title: 'custom-del-title' }
            }).then((result) => { if (result.isConfirmed) { db.ref('special_ads/'+key).remove(); showToast("Ad Deleted", "delete"); resetSpecialForm(); } })
        }

        function cleanupOldMessages() { const daysInput = document.getElementById('setting-comm-days').value; const days = daysInput ? parseInt(daysInput) : 30; const cutoff = Date.now() - (days * 24 * 60 * 60 * 1000); db.ref('community').once('value', snap => { if(!snap.exists()) return showToast("No messages to check", "error"); const updates = {}; let count = 0; snap.forEach(child => { if(child.val().timestamp < cutoff) { updates[child.key] = null; count++; } }); if(count > 0) { db.ref('community').update(updates).then(() => showToast(`Deleted ${count} messages older than ${days} days`, "delete")); } else { showToast(`No messages older than ${days} days`, "error"); } }); }
        function saveApp() { const name = document.getElementById('app-name').value; const desc = document.getElementById('app-desc').value; const ver = document.getElementById('app-ver').value || 'v1.0'; let cat = document.getElementById('app-cat-select').value; if(cat === 'custom') cat = document.getElementById('app-cat-custom').value.trim(); const logo = document.getElementById('app-logo').value; const link = document.getElementById('app-link').value; const id = document.getElementById('edit-id').value; if(!name || !link) return showToast("Fill all fields", "error"); const updateData = { name, category: cat, logo, link, version: ver, description: desc, timestamp: firebase.database.ServerValue.TIMESTAMP }; if(pendingApprovalKey) { updateData.downloads = 0; updateData.likes = 0; updateData.uploader = pendingUploaderName; db.ref('apps').push(updateData).then(() => { db.ref('pending_apps/'+pendingApprovalKey).remove(); showToast("App Approved & Published", "success"); resetForm(); }); } else if(id) { db.ref('apps/'+id).update(updateData).then(() => { showToast("App Updated Successfully", "success"); resetForm(); }); } else { updateData.downloads = 0; updateData.likes = 0; db.ref('apps').push(updateData).then(() => { showToast("App Published Successfully", "success"); resetForm(); }); } }
        function editApp(key, name, cat, logo, link, ver, desc) { pendingApprovalKey = null; document.getElementById('edit-id').value = key; document.getElementById('app-name').value = name; document.getElementById('app-desc').value = desc || ""; document.getElementById('app-logo').value = logo; document.getElementById('app-link').value = link; document.getElementById('app-ver').value = ver; const select = document.getElementById('app-cat-select'); const customInput = document.getElementById('app-cat-custom'); if(Array.from(select.options).map(o=>o.value).includes(cat)) { select.value = cat; customInput.classList.add('hidden'); } else { select.value = 'custom'; customInput.value = cat; customInput.classList.remove('hidden'); } document.getElementById('form-title').innerText = "Edit App"; document.getElementById('btn-save').innerHTML = "<i class='fas fa-save'></i> Update"; document.getElementById('btn-cancel').classList.remove('hidden'); showPage('apps'); window.scrollTo(0,0); }
        function resetForm() { pendingApprovalKey = null; pendingUploaderName = ""; document.getElementById('edit-id').value = ''; document.getElementById('app-name').value = ''; document.getElementById('app-desc').value = ''; document.getElementById('app-logo').value = ''; document.getElementById('app-link').value = ''; document.getElementById('app-ver').value = ''; document.getElementById('app-cat-select').value = 'Movies'; document.getElementById('app-cat-custom').classList.add('hidden'); document.getElementById('form-title').innerText = "Upload New App"; document.getElementById('btn-save').innerHTML = "<i class='fas fa-upload'></i> Publish"; document.getElementById('btn-cancel').classList.add('hidden'); }
        function saveSettings() { const loadTime = document.getElementById('setting-load-time').value.trim(); const bannerTime = document.getElementById('setting-banner-time').value.trim(); const headerMode = document.getElementById('setting-header-mode').value; const logoUrl = document.getElementById('setting-logo-url').value.trim(); const logoWidth = document.getElementById('setting-logo-width').value.trim(); const headerWidth = document.getElementById('setting-header-width').value.trim(); const headerMargin = document.getElementById('setting-header-margin').value.trim(); const ads = parseInt(document.getElementById('setting-ads').value); const commMode = document.getElementById('setting-comm-mode').value; const uploadMode = document.getElementById('setting-upload-mode').value; const zoneId = document.getElementById('setting-zone-id').value; const tgLink = document.getElementById('setting-tg-link').value; const autoDeleteDays = document.getElementById('setting-comm-days').value.trim(); const badgeDuration = document.getElementById('setting-badge-duration').value.trim(); const appName = document.getElementById('setting-app-name').value.trim(); const adminTitle = document.getElementById('setting-admin-title').value.trim(); const appColor = document.getElementById('setting-app-color').value.trim(); const appSize = document.getElementById('setting-app-size').value.trim();
        db.ref('settings').update({ loadingDuration: loadTime, bannerInterval: bannerTime, headerMode: headerMode, siteLogo: logoUrl, logoWidth: logoWidth, headerLogoWidth: headerWidth, headerLogoMargin: headerMargin, adsCount: ads, communityMode: commMode, uploadMode: uploadMode, monetagZoneId: zoneId, telegramLink: tgLink, autoDeleteDays: autoDeleteDays, newBadgeDuration: badgeDuration, appName: appName, adminTitle: adminTitle, appNameColor: appColor, appNameFontSize: appSize }).then(() => showToast("Settings Saved", "success")); }
    </script>
</body>
</html>
